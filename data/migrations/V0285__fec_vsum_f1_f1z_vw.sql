/*
This migration file is for #5663

1) Add `most_recent` column to fec_vsum_f1_vw using receipt_date and begin_image_number; Rewrite the subquery 
   using rank()

   Replaces V0038

2) Create fec_vsum_f1z_vw which has similiar struction to fec_vsum_f1_vw. sub_id is used in rank because of
   null value iin begin_image_num
*/

CREATE OR REPLACE VIEW public.fec_vsum_f1_vw AS
WITH the_rank AS (
      SELECT cmte_id, receipt_dt, begin_image_num,
			rank() OVER (PARTITION BY cmte_id ORDER BY receipt_dt , begin_image_num ) AS first_rank,
            rank() OVER (PARTITION BY cmte_id ORDER BY receipt_dt DESC, begin_image_num DESC) AS most_recent_rank
      FROM disclosure.nml_form_1
      WHERE delete_ind IS NULL AND rpt_yr >= 1977
)
SELECT f1.cmte_id,
    f1.cmte_nm,
    f1.cmte_st1,
    f1.cmte_st2,
    f1.cmte_city,
    f1.cmte_st,
    f1.cmte_zip,
    f1.cmte_email,
    f1.cmte_web_url,
    f1.cmte_fax,
    f1.cmte_nm_chg_flg,
    f1.cmte_addr_chg_flg,
    f1.cmte_email_chg_flg,
    f1.cmte_url_chg_flg,
    f1.filing_freq,
    f1.filing_freq_desc,
    f1.f3l_filing_freq,
    f1.filed_cmte_tp,
    f1.filed_cmte_tp_desc,
    f1.qual_dt,
    f1.efiling_cmte_tp,
    f1.filed_cmte_dsgn,
    f1.filed_cmte_dsgn_desc,
    f1.jntfndrsg_cmte_flg,
    f1.org_tp,
    f1.org_tp_desc,
    f1.leadership_pac,
    f1.lobbyist_registrant_pac,
    f1.cand_id,
    f1.cand_nm,
    f1.cand_nm_first,
    f1.cand_nm_last,
    f1.cand_m_nm,
    f1.cand_prefix,
    f1.cand_suffix,
    f1.cand_office,
    f1.cand_office_desc,
    f1.cand_office_st,
    f1.cand_office_st_desc,
    f1.cand_office_district,
    f1.cand_pty_affiliation,
    f1.cand_pty_affiliation_desc,
    f1.cand_pty_tp,
    f1.cand_pty_tp_desc,
    f1.affiliated_cmte_id,
    f1.affiliated_cmte_nm,
    f1.affiliated_cmte_st1,
    f1.affiliated_cmte_st2,
    f1.affiliated_cmte_city,
    f1.affiliated_cmte_st,
    f1.affiliated_cmte_zip,
    f1.affiliated_cand_id,
    f1.affiliated_cand_l_nm,
    f1.affiliated_cand_f_nm,
    f1.affiliated_cand_m_nm,
    f1.affiliated_cand_prefix,
    f1.affiliated_cand_suffix,
    f1.cmte_rltshp,
    f1.affiliated_relationship_cd,
    f1.cust_rec_nm,
    f1.cust_rec_l_nm,
    f1.cust_rec_f_nm,
    f1.cust_rec_m_nm,
    f1.cust_rec_prefix,
    f1.cust_rec_suffix,
    f1.cust_rec_st1,
    f1.cust_rec_st2,
    f1.cust_rec_city,
    f1.cust_rec_st,
    f1.cust_rec_zip,
    f1.cust_rec_title,
    f1.cust_rec_ph_num,
    f1.tres_nm,
    f1.tres_l_nm,
    f1.tres_f_nm,
    f1.tres_m_nm,
    f1.tres_prefix,
    f1.tres_suffix,
    f1.tres_st1,
    f1.tres_st2,
    f1.tres_city,
    f1.tres_st,
    f1.tres_zip,
    f1.tres_title,
    f1.tres_ph_num,
    f1.designated_agent_nm,
    f1.designated_agent_l_nm,
    f1.designated_agent_f_nm,
    f1.designated_agent_m_nm,
    f1.designated_agent_prefix,
    f1.designated_agent_suffix,
    f1.designated_agent_st1,
    f1.designated_agent_st2,
    f1.designated_agent_city,
    f1.designated_agent_st,
    f1.designated_agent_zip,
    f1.designated_agent_title,
    f1.designated_agent_ph_num,
    f1.bank_depository_nm,
    f1.bank_depository_st1,
    f1.bank_depository_st2,
    f1.bank_depository_city,
    f1.bank_depository_st,
    f1.bank_depository_zip,
    f1.sec_bank_depository_nm,
    f1.sec_bank_depository_st1,
    f1.sec_bank_depository_st2,
    f1.sec_bank_depository_city,
    f1.sec_bank_depository_st,
    f1.sec_bank_depository_zip,
    f1.tres_sign_nm,
    f1.sign_l_nm,
    f1.sign_f_nm,
    f1.sign_m_nm,
    f1.sign_prefix,
    f1.sign_suffix,
    f1.tres_sign_dt,
    f1.receipt_dt,
    f1.rpt_yr,
    (f1.rpt_yr + f1.rpt_yr % 2) AS election_cycle,
    f1.file_num,
    f1.prev_file_num,
    f1.mst_rct_file_num,
    f1.begin_image_num,
    f1.end_image_num,
    'F1'::text AS form_tp,
    f1.form_tp_desc,
    f1.amndt_ind,
    f1.amndt_ind_desc,
    f1.sub_id,
    CASE
        WHEN r.first_rank = 1 THEN 'Y'::character varying
        ELSE 'N'::character varying
    END AS first_form_1,
    CASE
        WHEN r.most_recent_rank = 1 THEN 'Y'::character varying
        ELSE 'N'::character varying
    END AS most_recent
FROM disclosure.nml_form_1 f1
LEFT JOIN the_rank r ON f1.cmte_id = r.cmte_id AND f1.receipt_dt = r.receipt_dt AND f1.begin_image_num = r.begin_image_num
WHERE f1.delete_ind IS NULL 
AND f1.rpt_yr >= 1977;


ALTER TABLE fec_vsum_f1_vw OWNER TO fec;
GRANT SELECT ON TABLE fec_vsum_f1_vw TO fec_read;

---
-- fec_vsum_f1z_vw
---
CREATE OR REPLACE VIEW public.fec_vsum_f1z_vw AS
WITH the_rank AS (
      SELECT cmte_id, receipt_dt, sub_id,
			rank() OVER (PARTITION BY cmte_id ORDER BY receipt_dt , sub_id ) AS first_rank,
            rank() OVER (PARTITION BY cmte_id ORDER BY receipt_dt DESC, sub_id DESC) AS most_recent_rank
      FROM disclosure.nml_form_1z
      WHERE delete_ind IS NULL AND rpt_yr >= 1977
)
SELECT f1z.cmte_id,
    f1z.cmte_nm,
    f1z.cmte_st1,
    f1z.cmte_st2,
    f1z.cmte_city,
    f1z.cmte_st,
    f1z.cmte_zip,
    f1z.cmte_email,
    f1z.cmte_web_url,
    f1z.cmte_fax,
    f1z.cmte_nm_chg_flg,
    f1z.cmte_addr_chg_flg,
    f1z.cmte_email_chg_flg,
    f1z.cmte_url_chg_flg,
    f1z.filing_freq,
    f1z.filing_freq_desc,
    f1z.f3l_filing_freq,
    f1z.filed_cmte_tp,
    f1z.filed_cmte_tp_desc,
    f1z.qual_dt,
    f1z.efiling_cmte_tp,
    f1z.filed_cmte_dsgn,
    f1z.filed_cmte_dsgn_desc,
    f1z.jntfndrsg_cmte_flg,
    f1z.org_tp,
    f1z.org_tp_desc,
    f1z.leadership_pac,
    f1z.lobbyist_registrant_pac,
    f1z.cand_id,
    f1z.cand_nm,
    f1z.cand_nm_first,
    f1z.cand_nm_last,
    f1z.cand_m_nm,
    f1z.cand_prefix,
    f1z.cand_suffix,
    f1z.cand_office,
    f1z.cand_office_desc,
    f1z.cand_office_st,
    f1z.cand_office_st_desc,
    f1z.cand_office_district,
    f1z.cand_pty_affiliation,
    f1z.cand_pty_affiliation_desc,
    f1z.cand_pty_tp,
    f1z.cand_pty_tp_desc,
    f1z.affiliated_cmte_id,
    f1z.affiliated_cmte_nm,
    f1z.affiliated_cmte_st1,
    f1z.affiliated_cmte_st2,
    f1z.affiliated_cmte_city,
    f1z.affiliated_cmte_st,
    f1z.affiliated_cmte_zip,
    f1z.affiliated_cand_id,
    f1z.affiliated_cand_l_nm,
    f1z.affiliated_cand_f_nm,
    f1z.affiliated_cand_m_nm,
    f1z.affiliated_cand_prefix,
    f1z.affiliated_cand_suffix,
    f1z.cmte_rltshp,
    f1z.affiliated_relationship_cd,
    f1z.cust_rec_nm,
    f1z.cust_rec_l_nm,
    f1z.cust_rec_f_nm,
    f1z.cust_rec_m_nm,
    f1z.cust_rec_prefix,
    f1z.cust_rec_suffix,
    f1z.cust_rec_st1,
    f1z.cust_rec_st2,
    f1z.cust_rec_city,
    f1z.cust_rec_st,
    f1z.cust_rec_zip,
    f1z.cust_rec_title,
    f1z.cust_rec_ph_num,
    f1z.tres_nm,
    f1z.tres_l_nm,
    f1z.tres_f_nm,
    f1z.tres_m_nm,
    f1z.tres_prefix,
    f1z.tres_suffix,
    f1z.tres_st1,
    f1z.tres_st2,
    f1z.tres_city,
    f1z.tres_st,
    f1z.tres_zip,
    f1z.tres_title,
    f1z.tres_ph_num,
    f1z.designated_agent_nm,
    f1z.designated_agent_l_nm,
    f1z.designated_agent_f_nm,
    f1z.designated_agent_m_nm,
    f1z.designated_agent_prefix,
    f1z.designated_agent_suffix,
    f1z.designated_agent_st1,
    f1z.designated_agent_st2,
    f1z.designated_agent_city,
    f1z.designated_agent_st,
    f1z.designated_agent_zip,
    f1z.designated_agent_title,
    f1z.designated_agent_ph_num,
    f1z.bank_depository_nm,
    f1z.bank_depository_st1,
    f1z.bank_depository_st2,
    f1z.bank_depository_city,
    f1z.bank_depository_st,
    f1z.bank_depository_zip,
    f1z.sec_bank_depository_nm,
    f1z.sec_bank_depository_st1,
    f1z.sec_bank_depository_st2,
    f1z.sec_bank_depository_city,
    f1z.sec_bank_depository_st,
    f1z.sec_bank_depository_zip,
    f1z.tres_sign_nm,
    f1z.sign_l_nm,
    f1z.sign_f_nm,
    f1z.sign_m_nm,
    f1z.sign_prefix,
    f1z.sign_suffix,
    f1z.tres_sign_dt,
    f1z.receipt_dt,
    f1z.rpt_yr,
    (f1z.rpt_yr + f1z.rpt_yr % 2) AS election_cycle,
    f1z.file_num,
    f1z.prev_file_num,
    f1z.mst_rct_file_num,
    f1z.begin_image_num,
    f1z.end_image_num,
    'F1Z'::text AS form_tp,
    f1z.form_tp_desc,
    f1z.amndt_ind,
    f1z.amndt_ind_desc,
    f1z.sub_id,
    CASE
        WHEN r.first_rank = 1 THEN 'Y'::character varying
        ELSE 'N'::character varying
    END AS first_form_1,
    CASE
        WHEN r.most_recent_rank = 1 THEN 'Y'::character varying
        ELSE 'N'::character varying
    END AS most_recent
FROM disclosure.nml_form_1z f1z
LEFT JOIN the_rank r ON f1z.cmte_id = r.cmte_id AND f1z.receipt_dt = r.receipt_dt AND f1z.sub_id= r.sub_id
WHERE f1z.delete_ind IS NULL 
AND f1z.rpt_yr >= 1977;


ALTER TABLE fec_vsum_f1z_vw OWNER TO fec;
GRANT SELECT ON TABLE fec_vsum_f1z_vw TO fec_read;
